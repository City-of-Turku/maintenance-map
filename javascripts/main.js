// Generated by CoffeeScript 1.6.3
(function() {
  var addMapLine, dropMapMarker, initializeGoogleMaps, map, snowAPI;

  snowAPI = 'http://dev.stadilumi.fi/api/v1/snowplow/';

  map = void 0;

  initializeGoogleMaps = function() {
    var mapOptions, styles;
    mapOptions = {
      center: new google.maps.LatLng(60.193084, 24.940338),
      zoom: 13,
      disableDefaultUI: true
    };
    styles = [
      {
        "elementType": "labels",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      }, {
        "stylers": [
          {
            "invert_lightness": true
          }, {
            "hue": "#00bbff"
          }, {
            "weight": 0.4
          }, {
            "saturation": 100
          }
        ]
      }, {
        "featureType": "road.arterial",
        "stylers": [
          {
            "color": "#00bbff"
          }
        ]
      }
    ];
    map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
    return map.setOptions({
      styles: styles
    });
  };

  dropMapMarker = function(lat, lng) {
    var marker, snowPlowMarker;
    snowPlowMarker = {
      path: 'M10 10 H 90 V 90 H 10 L 10 10',
      fillColor: '#DF740C',
      fillOpacity: 0.8,
      strokeColor: "#DF740C",
      strokeOpacity: 0.8,
      strokeWeight: 5,
      scale: 0.01
    };
    return marker = new google.maps.Marker({
      position: new google.maps.LatLng(lat, lng),
      map: map,
      icon: snowPlowMarker
    });
  };

  addMapLine = function(coords) {
    var i, j, k, nextSegment, polyline, steps;
    console.log(coords);
    polyline = new google.maps.Polyline({
      path: [],
      geodesic: true,
      strokeColor: "#f2e35e",
      strokeOpacity: 1.0,
      strokeWeight: 2
    });
    i = 0;
    while (i < coords.length) {
      steps = legs[i].steps;
      j = 0;
      while (j < steps.length) {
        nextSegment = google.maps.geometry.encoding.decodePath(steps[j].polyline.points);
        k = 0;
        while (k < nextSegment.length) {
          polyline.getPath().push(nextSegment[k]);
          k++;
        }
        j++;
      }
      i++;
    }
    return polyline.setMap(map);
  };

  $(document).ready(function() {
    var createPlowTrail, createPlowsOnMap, getActivePlows;
    getActivePlows = function(callback) {
      var plowPositions;
      plowPositions = Bacon.fromPromise($.getJSON(snowAPI + '?since=2hours+ago&callback=?'));
      return plowPositions.onValue(function(json) {
        return callback(json);
      });
    };
    createPlowTrail = function(plowId) {
      var plowPositions;
      plowPositions = Bacon.fromPromise($.getJSON(snowAPI + plowId + '?history=50&callback=?'));
      return plowPositions.onValue(function(json) {
        return addMapLine(json);
      });
    };
    createPlowsOnMap = function(json) {
      return _.each(json, function(x) {
        dropMapMarker(x.last_loc.coords[1], x.last_loc.coords[0]);
        return createPlowTrail(x.id);
      });
    };
    getActivePlows(function(json) {
      return createPlowsOnMap(json);
    });
    return initializeGoogleMaps();
  });

  console.log("%c                                                                               \n      _________                            .__                                 \n     /   _____/ ____   ______  _  ________ |  |   ______  _  ________          \n     \\_____  \\ /    \\ /  _ \\ \\/ \\/ /\\____ \\|  |  /  _ \\ \\/ \\/ /  ___/          \n     /        \\   |  (  <_> )     / |  |_> >  |_(  <_> )     /\\___ \\           \n    /_______  /___|  /\\____/ \\/\\_/  |   __/|____/\\____/ \\/\\_//____  >          \n            \\/     \\/ .__           |__|     .__  .__             \\/   .___    \n                ___  _|__| ________ _______  |  | |__|_______ ____   __| _/    \n       Sampsa   \\  \\/ /  |/  ___/  |  \\__  \\ |  | |  \\___   // __ \\ / __ |     \n        Kuronen  \\   /|  |\\___ \\|  |  // __ \\|  |_|  |/    /\\  ___// /_/ |     \n          2014    \\_/ |__/____  >____/(____  /____/__/_____ \\\\___  >____ |     \n                              \\/           \\/              \\/    \\/     \\/     \n                   https://github.com/sampsakuronen/snowplow-visualization     \n                                                                               ", 'background: #222; color: #00e5ff');

}).call(this);
